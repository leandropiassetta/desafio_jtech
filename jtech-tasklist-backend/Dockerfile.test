FROM eclipse-temurin:21-jdk-jammy

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Set GRADLE_USER_HOME for cache persistence
ENV GRADLE_USER_HOME=/gradle-cache

# Create cache directory
RUN mkdir -p $GRADLE_USER_HOME

# Copy only Gradle configuration files (for better caching)
COPY gradlew ./
COPY gradle ./gradle
COPY gradle.properties ./
COPY settings.gradle ./

# Warm up Gradle cache
RUN chmod +x ./gradlew && ./gradlew --version > /dev/null 2>&1 || true

# Copy source code
COPY src ./src
COPY build.gradle ./

# Default command
CMD ["./gradlew", "test", "--console=plain", "--no-daemon", "--info"]
